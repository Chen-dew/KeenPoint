"""
PPT ç”ŸæˆæœåŠ¡
æ ¹æ®è®ºæ–‡ç»“æ„å’Œå†…å®¹è‡ªåŠ¨ç”Ÿæˆæ¼”ç¤ºæ–‡ç¨¿
"""

from pptx import Presentation
from pptx.util import Inches, Pt
from pptx.enum.text import PP_ALIGN
from pptx.dml.color import RGBColor
import os
import tempfile
from typing import Dict, Optional
from app.core.logger import logger
from app.core.config import settings
from app.core.utils import generate_unique_id, ensure_directory_exists, get_timestamp

def generate_ppt(
    structure_data: Dict,
    include_images: bool = True,
    template: str = "default",
    options: Optional[Dict] = None,
    output_path: Optional[str] = None
) -> Dict:
    """
    æ ¹æ®è®ºæ–‡ç»“æ„ç”Ÿæˆ PPT
    
    å‚æ•°:
    - structure_data: è®ºæ–‡ç»“æ„åˆ†ææ•°æ®
    - include_images: æ˜¯å¦åŒ…å«å›¾åƒ
    - template: PPT æ¨¡æ¿
    - options: å…¶ä»–è‡ªå®šä¹‰é€‰é¡¹
    - output_path: è¾“å‡ºè·¯å¾„ï¼ˆå¯é€‰ï¼‰
    
    è¿”å›:
    - ç”Ÿæˆç»“æœ
    """
    logger.info(f"ğŸ“Š å¼€å§‹ç”Ÿæˆ PPTï¼Œä½¿ç”¨æ¨¡æ¿: {template}")
    
    try:
        # åˆ›å»ºæ¼”ç¤ºæ–‡ç¨¿å¯¹è±¡
        prs = Presentation()
        
        # è®¾ç½®å¹»ç¯ç‰‡å°ºå¯¸ï¼ˆ16:9ï¼‰
        prs.slide_width = Inches(10)
        prs.slide_height = Inches(7.5)
        
        # æ·»åŠ æ ‡é¢˜é¡µ
        _add_title_slide(prs, structure_data, template)
        
        # æ·»åŠ ç›®å½•é¡µ
        _add_agenda_slide(prs, structure_data, template)
        
        # ä¸ºæ¯ä¸ªç« èŠ‚æ·»åŠ å¹»ç¯ç‰‡
        sections = structure_data.get("sections_detected", [])
        for section in sections:
            _add_section_slide(prs, section, structure_data, template)
        
        # æ·»åŠ ç»“æŸé¡µ
        _add_closing_slide(prs, template)
        
        # ç¡®å®šè¾“å‡ºè·¯å¾„
        if not output_path:
            output_dir = os.path.join(settings.OUTPUT_DIR, "presentations")
            ensure_directory_exists(output_dir)
            filename = f"presentation_{get_timestamp()}_{generate_unique_id()[:8]}.pptx"
            output_path = os.path.join(output_dir, filename)
        
        # ä¿å­˜ PPT
        prs.save(output_path)
        
        logger.info(f"âœ… PPT ç”ŸæˆæˆåŠŸ: {output_path}")
        
        return {
            "ppt_path": output_path,
            "slide_count": len(prs.slides),
            "template": template,
            "status": "success"
        }
    
    except Exception as e:
        logger.error(f"âŒ PPT ç”Ÿæˆå¤±è´¥: {str(e)}")
        raise

def _add_title_slide(prs: Presentation, structure_data: Dict, template: str):
    """
    æ·»åŠ æ ‡é¢˜é¡µ
    
    å‚æ•°:
    - prs: Presentation å¯¹è±¡
    - structure_data: ç»“æ„æ•°æ®
    - template: æ¨¡æ¿åç§°
    """
    slide = prs.slides.add_slide(prs.slide_layouts[0])  # ä½¿ç”¨æ ‡é¢˜å¸ƒå±€
    
    # è®¾ç½®æ ‡é¢˜
    title = slide.shapes.title
    title.text = structure_data.get("title", "Academic Paper Presentation")
    
    # è®¾ç½®å‰¯æ ‡é¢˜
    if len(slide.placeholders) > 1:
        subtitle = slide.placeholders[1]
        subtitle.text = f"Based on Structure Analysis\nGenerated by AI Assistant"
    
    # åº”ç”¨æ¨¡æ¿æ ·å¼
    _apply_template_style(slide, template, "title")

def _add_agenda_slide(prs: Presentation, structure_data: Dict, template: str):
    """
    æ·»åŠ ç›®å½•é¡µ
    
    å‚æ•°:
    - prs: Presentation å¯¹è±¡
    - structure_data: ç»“æ„æ•°æ®
    - template: æ¨¡æ¿åç§°
    """
    slide = prs.slides.add_slide(prs.slide_layouts[1])  # ä½¿ç”¨æ ‡é¢˜å’Œå†…å®¹å¸ƒå±€
    
    title = slide.shapes.title
    title.text = "Agenda / ç›®å½•"
    
    # æ·»åŠ ç« èŠ‚åˆ—è¡¨
    content = slide.placeholders[1]
    tf = content.text_frame
    tf.clear()
    
    sections = structure_data.get("sections_detected", [])
    for i, section in enumerate(sections, start=1):
        p = tf.add_paragraph()
        p.text = f"{i}. {section}"
        p.level = 0
        p.font.size = Pt(18)
    
    _apply_template_style(slide, template, "content")

def _add_section_slide(prs: Presentation, section: str, structure_data: Dict, template: str):
    """
    æ·»åŠ ç« èŠ‚å†…å®¹é¡µ
    
    å‚æ•°:
    - prs: Presentation å¯¹è±¡
    - section: ç« èŠ‚åç§°
    - structure_data: ç»“æ„æ•°æ®
    - template: æ¨¡æ¿åç§°
    """
    slide = prs.slides.add_slide(prs.slide_layouts[1])
    
    title = slide.shapes.title
    title.text = section
    
    content = slide.placeholders[1]
    tf = content.text_frame
    tf.clear()
    
    # è·å–ç« èŠ‚è¯¦ç»†ä¿¡æ¯
    section_details = structure_data.get("details", {}).get(section, {})
    
    # æ·»åŠ å†…å®¹è¦ç‚¹
    bullet_points = [
        f"Key findings and contributions in {section}",
        f"Methodology and approach used",
        f"Results and analysis",
        f"Implications and future work"
    ]
    
    for point in bullet_points:
        p = tf.add_paragraph()
        p.text = point
        p.level = 0
        p.font.size = Pt(16)
    
    _apply_template_style(slide, template, "content")

def _add_closing_slide(prs: Presentation, template: str):
    """
    æ·»åŠ ç»“æŸé¡µ
    
    å‚æ•°:
    - prs: Presentation å¯¹è±¡
    - template: æ¨¡æ¿åç§°
    """
    slide = prs.slides.add_slide(prs.slide_layouts[0])
    
    title = slide.shapes.title
    title.text = "Thank You! / è°¢è°¢!"
    
    if len(slide.placeholders) > 1:
        subtitle = slide.placeholders[1]
        subtitle.text = "Q&A / é—®ç­”ç¯èŠ‚"
    
    _apply_template_style(slide, template, "closing")

def _apply_template_style(slide, template: str, slide_type: str):
    """
    åº”ç”¨æ¨¡æ¿æ ·å¼
    
    å‚æ•°:
    - slide: å¹»ç¯ç‰‡å¯¹è±¡
    - template: æ¨¡æ¿åç§°
    - slide_type: å¹»ç¯ç‰‡ç±»å‹
    """
    # æ ¹æ®ä¸åŒæ¨¡æ¿åº”ç”¨ä¸åŒçš„æ ·å¼
    if template == "academic":
        bg_color = RGBColor(245, 245, 245)  # æµ…ç°è‰²èƒŒæ™¯
    elif template == "modern":
        bg_color = RGBColor(30, 30, 30)  # æ·±è‰²èƒŒæ™¯
    else:  # default
        bg_color = RGBColor(255, 255, 255)  # ç™½è‰²èƒŒæ™¯
    
    # è®¾ç½®èƒŒæ™¯è‰²
    background = slide.background
    fill = background.fill
    fill.solid()
    fill.fore_color.rgb = bg_color

def customize_ppt(ppt_path: str, customizations: Dict) -> Dict:
    """
    è‡ªå®šä¹‰ PPT æ ·å¼
    
    å‚æ•°:
    - ppt_path: PPT æ–‡ä»¶è·¯å¾„
    - customizations: è‡ªå®šä¹‰é…ç½®
    
    è¿”å›:
    - æ›´æ–°ç»“æœ
    """
    logger.info(f"ğŸ¨ å¼€å§‹è‡ªå®šä¹‰ PPT: {ppt_path}")
    
    try:
        if not os.path.exists(ppt_path):
            raise FileNotFoundError(f"PPT æ–‡ä»¶ä¸å­˜åœ¨: {ppt_path}")
        
        prs = Presentation(ppt_path)
        
        # åº”ç”¨è‡ªå®šä¹‰è®¾ç½®
        theme = customizations.get("theme", {})
        font_settings = customizations.get("font", {})
        
        # éå†æ‰€æœ‰å¹»ç¯ç‰‡åº”ç”¨æ ·å¼
        for slide in prs.slides:
            # åº”ç”¨ä¸»é¢˜é¢œè‰²
            if theme:
                background = slide.background
                fill = background.fill
                fill.solid()
                bg_color = theme.get("background_color", "ffffff")
                fill.fore_color.rgb = RGBColor(
                    int(bg_color[0:2], 16),
                    int(bg_color[2:4], 16),
                    int(bg_color[4:6], 16)
                )
            
            # åº”ç”¨å­—ä½“è®¾ç½®
            if font_settings:
                for shape in slide.shapes:
                    if hasattr(shape, "text_frame"):
                        for paragraph in shape.text_frame.paragraphs:
                            for run in paragraph.runs:
                                if "font_size" in font_settings:
                                    run.font.size = Pt(font_settings["font_size"])
                                if "font_name" in font_settings:
                                    run.font.name = font_settings["font_name"]
        
        # ä¿å­˜ä¿®æ”¹
        prs.save(ppt_path)
        
        logger.info(f"âœ… PPT è‡ªå®šä¹‰å®Œæˆ: {ppt_path}")
        
        return {
            "ppt_path": ppt_path,
            "status": "success",
            "customizations_applied": list(customizations.keys())
        }
    
    except Exception as e:
        logger.error(f"âŒ PPT è‡ªå®šä¹‰å¤±è´¥: {str(e)}")
        raise

def add_image_to_slide(prs: Presentation, slide_index: int, image_path: str, position: tuple = None):
    """
    å‘æŒ‡å®šå¹»ç¯ç‰‡æ·»åŠ å›¾åƒ
    
    å‚æ•°:
    - prs: Presentation å¯¹è±¡
    - slide_index: å¹»ç¯ç‰‡ç´¢å¼•
    - image_path: å›¾åƒè·¯å¾„
    - position: å›¾åƒä½ç½® (left, top, width, height)
    """
    try:
        slide = prs.slides[slide_index]
        
        if position:
            left, top, width, height = position
        else:
            left = Inches(1)
            top = Inches(2)
            width = Inches(4)
            height = Inches(3)
        
        slide.shapes.add_picture(image_path, left, top, width, height)
        
        logger.info(f"âœ… å›¾åƒå·²æ·»åŠ åˆ°å¹»ç¯ç‰‡ {slide_index + 1}")
    
    except Exception as e:
        logger.error(f"âŒ æ·»åŠ å›¾åƒå¤±è´¥: {str(e)}")
